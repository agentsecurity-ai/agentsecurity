name: AgentSecurity CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install agentsec
        run: pip install -e "./tools/agentsec[dev]"

      - name: Run tests
        run: pytest tools/agentsec/tests/ -v --tb=short

      - name: Validate all templates
        run: |
          for dir in templates/*/; do
            echo "Validating $dir..."
            agentsec validate "$dir/AGENTSECURITY.md"
          done

      - name: Validate all examples (except bad-agent)
        run: |
          for dir in examples/langchain-agent examples/claude-code-project examples/financial-processor; do
            echo "Validating $dir..."
            agentsec validate "$dir/AGENTSECURITY.md"
          done

      - name: Verify bad-agent fails validation
        run: |
          if agentsec validate examples/bad-agent/AGENTSECURITY.md 2>/dev/null; then
            echo "ERROR: bad-agent should have failed validation"
            exit 1
          else
            echo "PASS: bad-agent correctly fails validation"
          fi

  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Install jsonschema
        run: pip install jsonschema

      - name: Validate JSON Schema is valid
        run: python -c "
import json, jsonschema;
schema = json.load(open('spec/agentsecurity.schema.json'));
jsonschema.Draft202012Validator.check_schema(schema);
print('Schema is valid')
"
